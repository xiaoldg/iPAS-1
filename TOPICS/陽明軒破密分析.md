Summer Camp - Crypto
===

[練習網站 All-CTF](http://140.110.112.28)
[練習網站 Crypto-CTF](http://140.110.112.30)
[聊天室](https://tlk.io/campcrypto)
[檔案下載](https://tinyurl.com/ydyq4w52)




# 基本的一些小東西
## 數字 < - > 文字 轉換
python3 - 使用 pycrypto
```python
In [1]: from Crypto.Util.number import *

In [2]: msg = b'ntust'

# 將文字轉數字
In [3]: bytes_to_long(msg)
Out[3]: 474400256884

# 將數字轉文字
In [4]: long_to_bytes(474400256884)
Out[4]: b'ntust'
```

python3 - 使用 binascii

```python
In [13]: import binascii

In [14]: msg = b'ntust'

# 這邊將 文字轉成十六進制
In [15]: binascii.hexlify(msg)
Out[15]: b'6e74757374'

# 轉為 十進制
In [16]: num = binascii.hexlify(msg)
In [17]: int(num,16)
Out[17]: 474400256884


## 轉數字為文字
In [19]: num = 474400256884

In [20]: hex(num)
Out[20]: '0x6e74757374'

In [21]: hex(num)[2:]
Out[21]: '6e74757374'

In [22]: s = hex(num)[2:]

In [23]: binascii.unhexlify(s)
Out[23]: b'ntust'


```

或者可以使用[線上工具](https://codebeautify.org/hex-string-converter)




# DES
加密算法流程圖 - 取自 CTF WIKI
![](https://i.imgur.com/Z4F8Hky.jpg)


[DES_wiki](https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E5%8A%A0%E5%AF%86%E6%A8%99%E6%BA%96)

## Weak key

參考:
[wiki](https://en.wikipedia.org/wiki/Weak_key)



簡單講原理:

DES 的金鑰產生是用 56 bits 的金鑰去算出 16 把 subkeys ，然後他一共有 16 個回合，每次用一把 subkeys ，加密和解密就差在使用 subkey 的順序，而如果你的金鑰是用 弱金鑰的話，算出的 16 把 subkey 會完全一樣，所以造成加解密完全一樣。
`E(E(m)) = m`

而半弱金鑰則是會產生兩把 subkeys ，所以半弱金鑰會是一組兩把，你可以用第一把加密，再用另一把加密 = 解密
`Ek1(Ek2(m)) = m`






題目練習:
- SharifCTF 8 2018 - DES

答案格式: SharifCTF{key}



可以用個簡單小程式看一下
```
#!/usr/bin/env python
from Crypto.Cipher import DES

m = '89bc8acb348c1ecc'
c = '9e31e5f5a8cef654'
key = ['\x01\x01\x01\x01\x01\x01\x01\x01',
'\xFE\xFE\xFE\xFE\xFE\xFE\xFE\xFE',
'\xE0\xE0\xE0\xE0\xF1\xF1\xF1\xF1',
'\x1F\x1F\x1F\x1F\x0E\x0E\x0E\x0E']
for k in key:
	des_func = DES.new(k, DES.MODE_ECB)
	if m == des_func.decrypt(c.decode('hex')).encode('hex'):
		print "key: ",k.encode('hex')
		break
```
最終 flag: `SharifCTF{E0E0E0E0F1F1F1F1}`



# AES
加密算法流程圖 - 取自 CTF WIKI
![](https://i.imgur.com/lHnicDs.jpg)

# Mode

## ECB
[練習網址](https://id0-rsa.pub/problem/26/)

```

m1:"Deposit amount: "
c1:5797791557579e322e619f12b0ccdee8
m2:"One million doll"
c2:b1e952572d6b8e00b626be86552376e2
m3:"ars"
c3:fdf526bd557b045bce65a3b3e300b55e

答案:

5797791557579e322e619f12b0ccdee8b1e952572d6b8e00b626be86552376e2fdf526bd557b045bce65a3b3e300b55e
```


## OFB
題目練習:
- AIS3 Final 2015 - Crypto 2


在本地開服務起來:
```
$ ncat -vc 'python src.py' -kl 1234
```

本地連線過去
```
$ nc localhost 1234
```


解題參考程式碼:

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-
from pwn import *

HOST = '127.0.0.1'
PORT = 1234

r = remote(HOST ,PORT)

p = 'ais3{'

r.recvuntil('decode the cipher:\n')
c = r.recvuntil('\n')[10:-1]
# 因為我知道開頭就是 ais3{ ，所以我就先略過前五個

## 這裡先存 100 筆資料
l = []
for _ in range(100):
	r.sendlineafter('Calcuate the passcode...(Press any key to continue)\n', 'any')
	l.append(r.recvuntil('\n')[10:-1])

## 已經不需要連線了，就先關閉
r.close()

## pn 用來存找到的 AES(iv, key)
pn = []
tmp = True

## k 用來依次找後 27 個AES(iv, key)
## i 窮舉 0 - 255
## for t in l 這邊是比對 xor 出來是否符合再英文小寫範圍
for k in range(0, 54, 2):
	for i in range(256):
		for t in l:
			xor_result = int(t[k:k+2],16) ^ i
			if xor_result < 97 or xor_result > 122:
				tmp = False
				break
		if tmp:
			pn.append(i) 
		tmp = True

## 將 AES(iv, key) xor C = P
for i in range(0, 54, 2):
	p += chr(int(c[i:i+2],16) ^ pn[i/2])


print "find the flag: ",p

# 97 - 122 # a - z
# ais3{......} # length = 32
```

## CTR

OWO_Nonsense-Machine

```python
#!/usr/bin/env python
from pwn import *

HOST = '120.114.62.87'
PORT = 4119

r = remote(HOST, PORT)

trash = "nonsensenonsense"

r.recvuntil('Here is your flag : ')
flag = b64d(r.recvuntil('\n')[:-1])

r.recvuntil('You also need to tell me some nonsense\n')

while 1:
	enc_trash = b64d(r.recvline()[:-1])
	tmp = xor(enc_trash, trash, flag[:16]) 
	if 'MyFirstCTF' in tmp:
		print tmp
		break
	r.sendlineafter('your turn :', "a")

r.sendlineafter('your turn :', "a")
	
while 1:
	enc_trash = b64d(r.recvline()[:-1])
	tmp = xor(enc_trash, trash, flag[16:]) 
	if '}' in tmp:
		print tmp
		raw_input("#")
	r.sendlineafter('your turn :', "a")

r.close()
```


# Length Extension Attack
tool: hashpump
[github](https://github.com/bwall/HashPump)

安裝:
```
sudo pip install -U pip

sudo pip install hashpumpy
```


bash 下使用
```
Input Signature: 3889c1343d0ae865bdb68a973280265168fa2e7c31cfc19591136d2f82d2fe6b
Input Data: Anr9Ecttjm
Input Key Length: 20
Input Data to Add: 8X3kU8nKpP
2ebf252b317a0b3a3f890218819ebd283da458c47378178343c70d43700ddfec
Anr9Ecttjm\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf08X3kU8nKpP

```



# rsa

library 安裝:

安裝 gmpy2
```
sudo apt-get install python3-gmpy2
```

安裝 pycrypto
```
sudo apt-get install python3-pip

sudo  python3 -m pip install -U pip

sudo python3 -m pip install pycrypto
```


安裝 yafu
```
wget http://sourceforge.net/projects/yafu/files/latest/download
mkdir yafu
command -v unzip >/dev/null 2>&1 || { echo >&2 "I require unzip but it's not installed.  Aborting."; exit 1; }
unzip -d ./yafu download && rm download
```



## tool 

### RsaCtfTool

[github](https://github.com/Ganapati/RsaCtfTool)

```
./RsaCtfTool.py --publickey PublicKey.pem --private --uncipher ciphertext
```

## YUBITSEC CTF RSA II 2017

### 讀公鑰

```python
from Crypto.PublicKey import RSA

key = RSA.importKey(open("PublicKey.pem", "rb"))

e = key.e
n = key.n
```

### 分解 n

丟到 factordb.com ，可以得到 p , q
```python
p = 259117086013202627776246767922441530941818887553125427303974923161874019266586362086201209516800483406550695241733194177441689509238807017410377709597512042313066624082916353517952311186154862265604547691127595848775610568757931191017711408826252153849035830401185072116424747461823031471398340229288074545677907941037288235820705892351068433882986888616658650280927692080339605869308790500409503709875902119018371991620994002568935113136548829739112656797303241986517250116412703509705427773477972349821676443446668383119322540099648994051790241624056519054483690809616061625743042361721863339415852426431208737266591962061753535748892894599629195183082621860853400937932839420261866586142503251450773096274235376822938649407127700846077124211823080804139298087057504713825264571448379371125032081826126566649084251699453951887789613650248405739378594599444335231188280123660406262468609212150349937584782292237144339628858485938215738821232393687046160677362909315071

q = 190797007524439073807468042969529173669356994749940177394741882673528979787005053706368049835514900244303495954950709725762186311224148828811920216904542206960744666169364221195289538436845390250168663932838805192055137154390912666527533007309292687539092257043362517857366624699975402375462954490293259233303137330643531556539739921926201438606439020075174723029056838272505051571967594608350063404495977660656269020823960825567012344189908927956646011998057988548630107637380993519826582389781888135705408653045219655801758081251164080554609057468028203308718724654081055323215860189611391296030471108443146745671967766308925858547271507311563765171008318248647110097614890313562856541784154881743146033909602737947385055355960331855614540900081456378659068370317267696980001187750995491090350108417050917991562167972281070161305972518044872048331306383715094854938415738549894606070722584737978176686422134354526989443028353644037187375385397838259511833166416134323695660367676897722287918773420968982326089026150031515424165462111337527431154890666327374921446276833564519776797633875503548665093914556482031482248883127023777039667707976559857333357013727342079099064400455741830654320379350833236245819348824064783585692924881021978332974949906122664421376034687815350484991

## n == p*q
```

有了 p 和 q 可以算 phi(n)
```python
phi_n = (p-1) * (q-1)
```

有了 phi(n) 和 e 可以求出私鑰

```python
import gmpy2

d = int(gmpy2.invert(e, phi_n))
```

這邊先把我們要解密的密文讀進來
```python
c = open("ciphertext","rb").read()
```
因為讀進來的密文是 raw data ，這邊先把她轉為數字
```
from Crypto.Util.number import *
c = bytes_to_long(c)
```

因為現在我們有了私鑰，所以可以直接解密密文
```python
m = pow(c,d,n)
```

得到明文後，把他轉回文字
```
from Crypto.Util.number import *

print long_to_bytes(m)
```


## AIS3_Pre_exam_2015-Crypto2


```python
#!/usr/bin/env python
from Crypto.Util.number import *
import gmpy2

p = 800644567978575682363895000391634967
q = 83024947846700869393771322159348359271173
n = 66473473500165594946611690873482355823120606837537154371392262259669981906291
e = 65537

c = open('flag.enc', 'rb').read()
c = bytes_to_long(c)

phi_n = (p-1)*(q-1)
d = int(gmpy2.invert(e, phi_n))
m = pow(c, d, n)
print(long_to_bytes(m))
```

## YANG_RSA-1
這題可以直接分解 n (使用 factordb.com )

```python
#!/usr/bin/env python
from Crypto.Util.number import *
import gmpy2

p = 2262150367
q = 3006300461
r = 12218233223644524650141958853163065112163255395621655741865064529020634406575730714768264558014607893896434523845321502371618344594488810317052606914954669

n = 83092583783534841000145280642003842283533340442637642451258941907393275732996256523893438356692786223410880194199043046345864683398238392329295750150314289824255749149834103

e = 11

c = 32392151763267291269610586564983347951891395196084251182633225594245167922176424232164117237142038355860036871811244158149537196288428230971760474130300660929743492107190512

phi = (p-1)*(q-1)*(r-1)
d = int(gmpy2.invert(e, phi))
m = pow(c,d,n)
print(long_to_bytes(m))
```

## YANG_RSA-2
```python
#!/usr/bin/env python
from Crypto.Util.number import *
import gmpy2

n = 1005098784594165848821832590501628403524802902674053382968470498538675288024873128424879364961488454145355936225677709124632789481770148984368708158164916266844271786072406765898627538801884748356080826075494258116818573097428235536790636847100997446916017821607591551722483794674940379793999230206353715117589898489861301662334780242666620337676110221421426102941068711974618344098371538140671153829377393837740293830337243493085160451872753422509384072905634851957789103689582476286664749588114456827960476870164048784404280351460249562996906271414272625881748849175309114734205368513000888013065441040602267654552015590863773059574256085653649422840863428324602357578340644446996674941825103598620438972286389472676382307637357209115141975325946791432841852827828407465818721747161090664009799105129953728589693126992849713556841586265400095017954688319716059398240941350468461830314384384626840855999556176928576367255322330539451380078690665639135509274932616776447492100759094249811584415361859939091438557866035439570864472528889723274777281738473905899882030941410513275852891694991922437995200537246398155615904052214367857177598437501143127042446835618109714924845047124233631838729882640996639575165133299706184551662489093

e = 7

c = 44163895521220531459057055795752057167876718238617963549906371036055586914199267109947281359325715489398261335563468559859879340774499726524035061903919328383390193234339356811666801858858748990899697833645511123626735258871404048116302274347058468791179874933001105300534600581977271895856972533976629641765182868484553104584590829347999386472615066779248550781718812068424236647225425670871554757459074630360567280382876137651283102473254886990887517217176132596555364994651622062720390486911698802074418697530462711619997107804919499320409084297665919116751543056038865957808455949742740596859550586982302492545205898434968509344729243293414190715139959127090472661918871372070659935437431160846169010492251366727698703670348564864343164944932175842131148853297549424891479394079434940030257530096990169847176293150870765433888895069248560702669885642923421945661068042034911026426121363007026093515922333722778955975053692081279596854554640425470049534192255739670036469

m, _ = gmpy2.iroot(c,e)
m = int(m)
print(long_to_bytes(m))
```

## YANG_RSA-3
```python
#!/usr/bin/env python
from Crypto.Util.number import *
import gmpy2


c = 139042738526108915518382315590614161559545672874231013930043771888153330995636895021496690157019719891495421789891311751114070162820109898550748729125606711558619118645191771802867431417997808791808947663873157450381886576198018116644175503419727838166069179286320364053606871929319609609717883881827703531071294250903725115590903885439257993122448450155592341119519506480784700882637629148100289455951870378287065580019819787172666799064867472787388018501312484677758639630205985303521919625967928777576894714176370710514866851261857421113481579194403231201302648732458813285636116381750742800141620920665296851274731594398742733371863332481364651903565612256089078337832051794479664232703579382433662773172010772985745670472577141377427032667489413571147659184721008370862939384402765999758594739567633919697832750413509665699046792692953501205991502771826582951017086701333243949551066796272454956773817169423364362577405931516463850167131352119912514527378117187253789191465090914208628886222374130328836743075062815304664169005843065539134914179702827261596407513474449624318873499341773097243

e = 10000001

n1 = 3627444771006641937670374103598493492277170277116493920932885955435916968318288577415856168749785331840818803112714250474056975340846972000039130600885450836486139285287969449202825040685732379632326635633418300048983634209556964867175030252399986593427857865008518171239775643235488954015082260035235036283487660366488550474516338472679222048717177747614210739606052154819639691004286246240020230188651006378959767398084324322008453152063183987372973164598066860174889163715767177543295634165129243441461597670797375484554640164983017774064835500981051070425037996029762438322599385986157913795423953648261358937185717844177379683832237044491180000482549114763268386632780913610754235834240512650659409215396821697752992594864370658750560426230664402293637048067412815299294991452283113777309961811323532557633057727900060941499142193907009891170468728522049291402072655778336976688416252463974783689158463516778651386914053541081481476612718983711795850458476656130316790582555711188904501523691656768916238612527464448411081019203952981305496349455714491843585609791073272252568166553125529140639

n2 = 3627444771006641937670374103598493492277170277116493920932885955435916968318288577415856168749785331840818803112714250474056975340846972000039130600885450836486139285287969449202825040685732379632326635633418300048983634209556964867175030252399986593427857865008518171239775643235488954015082260035235036283487660366488550474516338472679222048717177747614210739606052154819639691004286246240020230188651006378959767398084324322008453152063183987372973164598066860174889163715767177543295634165129419489479581992906703549293578307256488898187992353900184420118800322552534062759653705575925115281872928967944090554962523467896972290709767538721152187005614513210255277428624583175610744256739492598420738558920178579717917167080004296928204063086948663685116578675918309866385297630728361719704990361341156140881005762465007490782078136991995257037173077806031411193484423581964394970840431076138212137582851077173111409746242976470913498571389253297470379823689833891657511115618469031966199517813387433692841129826086480794218247482240815273496487448622735466819104529863148460012391153385059278883


p_q = (n2 - n1 - 4) // 2
n1_phi = n1 - p_q + 1
n2_phi = n1 + p_q + 1
d1 = int(gmpy2.invert(e, n1_phi))
d2 = int(gmpy2.invert(e, n2_phi))

m = pow(pow(c,d2,n2),d1,n1)
print(long_to_bytes(m))
```


## common modulus attack
```python

import gmpy2

def common_modulus_attack(e1, e2, c1, c2, n):
	_, s1, s2 = gmpy2.gcdext(e1, e2)
	s1 = int(s1)
	s2 = int(s2)
	if s1 < 0:
		s1 *= -1
		c1 = int(gmpy2.invert(c1, n))
	if s2 < 0:
		s2 *= -1
		c2 = int(gmpy2.invert(c2, n))
	m = (pow(c1, s1, n) * pow(c2, s2, n)) % n
	return m
```

### YANG_RSA-4
```python
#!/usr/bin/env python
from Crypto.Util.number import *
import gmpy2

n = 601079890037987604431299524604731926071028289714726325853160560822671656672435372422576831180720643755002522349232818450429861500646197062814617330443684235014072184166957803892385199122293587039674209300946383069422025584266381942233078984155793427549685573859988475888412265342970813238059596786787726537911926819530604506451125553192260570386165641188535428166442552194316166923180962521164985215427597102736331300655293153400150333265029368210022213821641355315765165160575924342098863168232177127592546541673292314097366431474533263402112899677852636579661059026081681362887721283820517246291325501590627370903464556352593996466395596703609515756817330200509325258443030773008998508183500802902995673573898878264148773130870857827804095652545116545220268517058077827666474665032138823605624731794285434772957308460566796728714912951423416600299440344847642523901665983827164682786888788009473126538180992204754454924702201128344623836080923997277509247815993

e1 = 9405172090867429167522098902370749942248783790897104683679576493285386831759923838256124796722772712748691601513080032494804780492783260329501965883487449

c1 = 314564217302500200163759194260307839612780113900510659153559994404616233480977901081457219754701436603071046288000515552874294832582078073029908088537206127804857317570661216485480824510676318602134918119497217616722217174492657585743425124324907518649050736733207674535351855501078377195724227557781044380284792016437708580643509685246825169537653244291413420860826461482786045694551841250154752831892803997686933358830881165202213705675567254258355536168864546096585003491156446528289098171464737969907311920151343401576297553073358616531239922292236598022573879617946865136850496267767392774321261208975997120995221104766187122831500354603374561481266350294614422561126906570941980870039995358850974794393980407489204820700624300046702300701395126669428361520630043416955672898292369148908985504063716178629319516455430033390711455943419623574412135759361201047051736309026022515055418451530574539575536836664360617505814472330359018776028176730183083132708449

e2 = 7095565993271201701012700380853978907656102167234011354220093122363055999144351553656782816939748882018682837387651451192207734678816900790888793405286989

c2 = 231454535634498981606804851249268972673565707091933518210376565934116042099763364768783318579394065863001071012758012388779888046220585794303803977781363299140700033882412332072165508546466694644149936737091441176316685512052479450517620932425763542699912556932121122254624930817149270005252865287721155021484087246788171305870704141493508455874364528923527573135942464626727511007260700119374884220390067900433849409633808845764301976479013370962776101364599847645005622330078930265786460112041493284689945296841349882069189318814764669930730356315943075593805608591847059144964078117070976633698053027833770233512967762552688778510572408743102454627944221473329378344576994239421959385787556811017060321709056461254892708398556778100555192544461572784992678053844380781805360413711742586700791882806136633296551922581431775955348872645753475792127252625290521427755906342341946264099004311435719226771725446922256895733539634456628491176695552090922403849365718



def common_modulus_attack(e1, e2, c1, c2, n):
	_, s1, s2 = gmpy2.gcdext(e1, e2)
	s1 = int(s1)
	s2 = int(s2)
	if s1 < 0:
		s1 *= -1
		c1 = int(gmpy2.invert(c1, n))
	if s2 < 0:
		s2 *= -1
		c2 = int(gmpy2.invert(c2, n))
	m = (pow(c1, s1, n) * pow(c2, s2, n)) % n
	return m

m = common_modulus_attack(e1, e2, c1, c2, n)
print(long_to_bytes(m))
```

## rsa 後門(1)
```python
#!/usr/bin/env python
from Crypto.Util.number import *

n = 760070912350840319011516178942471824408271276603018122766107466458905659805366910876741133101064132968975290327141913870064382857896676965896339499301686289349478192042225387715815300890772726396671069777379993317290403468858998199888875329375096856205675179863574081470688602128633185902300536380591686253782626310388376732381905094112550405708724116437892957067685087277238106233348311268725082471734753857194847838970086800848099069387690801700501505622593836970903856921989336476413802534078525413311063453348054161408156303570666333425678334142525184422436235677229592264286240481233065103525594733333609350428196011268071126676023443256564227488106063073893805882904030218186925942692848016877882566240601003792167543787342287123520711449083265386813671510310650585456131441220450039511889734856795425972738718472877437781909089006687000385532764327586589650518853864825005505232375529254511923368560433385960598232647516144607822711918385784586608803888123523660880157194471094579495414720939362559417376095025821133997982361566429601158965282863289774835745836514384219847770664031196660782737380240398358478721495348483958183701077510621561366810555045657804658889409015678773329196458757404769771384361180527520601391357800258141800488661477548160080188323687255844523623758493111371703516522245476661361074371234254770474249888532163823739762576169486427817071850060196906194007205553628806031759720577392913205266258974893510396850982203198212807648844222854214722691172053026220943259272390113639543712309874760232956983371190047789729422160337209334177864706118802632248174293863932718038360834909893547570166552708085714105225222230703430768672212375445000147155804641468351838745755024401386395525712050470895155325019568159034388240484857157405320152956355210692650494136549140160597175749
e = 65537
c = 23043402590987555987470005871777877151151322716060092459929038792187374705968922913981882558830225470321029330756473052187571435747992606303872345391192250986189523554344860876217195521571582376245238947762932906008745950998260974696231231824601028638289006875327541511759557000571143570848503096379667666967042396170909355179367747237803420662010299628257013342744836612954085028392265365961440279234959713291284949713775237855329413455655772310421877970592292542102538256515263604910522531928228880078584842456141579974665432527149970116608055188948668252221996589209114900583773037478077453666787948360947075322921408423852746262833539233406967548960178792506005300931929791663889585748150722426246846945324183653314928671217591271109921760823893150502841856609499818424934712192715672939108605032696495577793313699830025230983849952517890751090570666447986086847837086779757192278809702226557559967552406759613743288491173421943288898163371672471990115969010871440555604481217266874916781598035536414979414464006324273200204670733327544831907946399527743271591693219872979511671485433003231621892498425559325421320388096593342519672705301186660848415575840192111782413754304841694673552200242842522814616994132736554544962232150040663460968513256281961794248016394841074724067661800839577955360386734635675931880822030409894997770620409228346807030968725967258287589342081617955999751395789800908644912870435347895906209405598557569815132825199794518175327458521867303551685164794679068776727276119468526737538107724423172989004606420592240046923867223729763034260869375338820559888057264343970350523466971697923158383084508306076913151571967057252009643027901618887695230860718585529467899380034905236786873876780870273574985011685074373247696219994297416533789436191368362809767858885056459978807647
d2e_7phi = 1620126254178307107805925347409210109079418631271539038205383853825500296811505131321875475715376307920981259462614357533466941753203754184389902040317390296735523174111832078921071210983364802271706444506677317213375748433529142733682590086434843883159602424571840661084006789837565204356906806127384353403137070496607341705255529168928432860284811151663733497947457852894849483010205070190430044884550533111192278310167522337536246523319753834614895078829866621645079609537944800585691132921447071067406128053795992296555789860705164267117376403341249194265381912880381122911987670787720090648797468392804379581428828927625443096354958698305106425356304804759341769351628590201355981787898026961417197010017978586896498369566391766916389949150734429923140437868014851873995161973857943326484813660496439427382145248573160747328757222766985442936636962614338471082462176542018466676085655454126951355550126361556257104662075266568603316336712255778109160502274520531194415105288138253088913783390737905518421815608069570180353522268625980073518750189827406619294497755771287793106258255192904299584048308228213978894683176026406779635394795370495734518744326300256193256380087951019044375347232461900888446065009489097640645391262386569608187845289178411183302612154855933859365795959462296302969045375802007650006363182447142282246172159815897175833698776663254485330016779371149328376513575569112760942981544834502925172841196048299545002337578813030918604554192291352785887470669511311646710910107563532165621630764987769666815016543655079038651842299906822911300266765706794298700862048041414816161796925300877951583684498109038799176817515156155043226336378501966674335980213598353300400499799267983331829293506615875633931684214060079961057050811529994328542272465237370490978257671901267949207368118469813482528549191337691272398251984525988911374674261415802154066814829811852235633680796855638371608427840349392807069113908188523610318541628405008514061483659101476049254558271853247155909822423178322733169352572052726772582248896209811295644754652929887794307253538519583308522548764807171997390978930362807674618922673784345674399280165757903254849166255862761505958877746491695638693225723742471994074977722764774396977099203362493734497024157950664679560033045482790511829641981266050781145047063439829017411287025152601657710843117158464125963489235207735032378012469116305985018154124770869140988608396527280659847552980183759392006298043098302142036369831264210519529460144456046718107048666133409389414971293612254496187041396109788710182456978219643383191376104152139390281682725843970462663476429188678725076567909771351453134707771292457507252653887820906120220438288603368324527890395568883849113861497960739320824870111660002336940925676213182090142135460146471543405919951993709743278922880730501901447471415221734066265696076586382009664274086330323532584722108261464690626012127056796760247870942832409248150162628837118556643673490483508340076601494462894830031383023978791318416731750735151837937806847488275195597134674111405788736045846451812924630643394346576798523225002203801819682823374228410113250193049149956290221614268899002507311843085666803688279048710674142634342181537227528937600806325860076859203781668984084015772848021783541825345156247897291696817517617346614862474694333096308102196024040585991378871897997839002740030027319532462250477445464847537717734353083321981680750712108267543263803466885591366936121859171083424502493973267513173320411368750946440514079437531574281488938077212799745537360636372874039590628648466074136236105865275970476148518382544665640833

m = pow(c, d2e_7phi, n)

print(long_to_bytes(m))
```

## rsa 後門(2)
https://programmingpraxis.com/2016/01/19/rsa-encryption-backdoor/

## SECCON2017_Ps and Qs

```python
#!/usr/bin/env python
from Crypto.PublicKey import RSA
import gmpy2

c = bytes_to_long(open('cipher', 'rb').read())
n1 = RSA.importKey(open('pub1.pub').read())
n2 = RSA.importKey(open('pub2.pub').read())
# assert libnum.gcd(n1.n, n2.n) != 1

p = int(gmpy2.gcd(n1.n, n2.n))
q1 = n1.n // p
q2 = n2.n // p
e = 65537
d1 = int(gmpy2.invert(e, (q1-1)*(p-1)))
d2 = int(gmpy2.invert(e, (q2-1)*(p-1)))

m1 = pow(c,d1,n1.n)
m2 = pow(c,d2,n2.n)
m1 = long_to_bytes(m1)
m2 = long_to_bytes(m2)
if b'SECCON' in m1:
	print(m1)
else:
	print(m2)
```

## AIS3_Pre_exam_2016-Crypto3
```python
#!/usr/bin/env python
from Crypto.Util.number import *
from Crypto.PublicKey import RSA
import os
import gmpy2

filenames = next(os.walk("."))[2]
c = bytes_to_long(open('../flag.enc', 'rb').read())

for i in filenames:
	for j in filenames:
		if i == j:
			continue
		ki = RSA.importKey(open(i,'rb').read())
		kj = RSA.importKey(open(j,'rb').read())
		p = int(gmpy2.gcd(ki.n, kj.n))
		if p != 1:
			e = kj.e
			n = kj.n 
			q = n // p 
			phi = (p-1)*(q-1)
			if gmpy2.gcd(e, phi) != 1:
				break
			d = int(gmpy2.invert(e, phi))
			m = pow(c,d,n)
			m = long_to_bytes(m)
			if b'ais3' in m:
				print(m)
				input("")

```

# ElGamal

原根參考:
- [Primitive root](https://talknumber.blogspot.com/2011/07/primitive-root.html)
- [[數論] 原根 (Primitive Roots)](http://gotonsb-numbertheory.blogspot.com/2014/06/primitive-roots.html)


ElGamal_reuse_k 解題:
```python
#!/usr/bin/env python
from Crypto.Util.number import *
import gmpy2


m1 = b'Encryption System!\n'
m1 = bytes_to_long(m1)
m1_c2 = 1326156753053424438142837449127171994267675817778147473382143489037397256432
y = 3410934722162955468945973124605105458336254957517333308768550599815674681
g = 2
p = 1465147812640682222554264409449933998206290086054031427525815825902178660531
m2_c2 = 419237427856630524621541760152203582679209997947785293872845931273250082715

yk = (m1_c2 * int(gmpy2.invert(m1, p))) % p
m2 = (m2_c2 * int(gmpy2.invert(yk, p))) % p

print(long_to_bytes(m2))
```



# ECC
Simplest_ECC

```python
#!/usr/bin/env python
import gmpy2

a = 4788000822933941356
p = 10390178628259865209
P = (394030696516212836363621, 23484796774739559)
d = 4412486
def add_point(x, y):
	if y == 0:
		return x
	x1, y1 = x
	x2, y2 = y
	if x == y:
		t = ((3*x1*x1 + a) * int(gmpy2.invert(2*y1, p))) % p
	else:
		t = ((y2 - y1) * int(gmpy2.invert(x2 - x1, p))) % p
	x3 = (t*t - x1 - x2) % p
	y3 = (t * (x1 - x3) - y1) % p
	return (x3, y3)

G = 0
for i in range(d):
	G = add_point(P, G)

sum = hashlib.md5(str(G[0]+G[1])).hexdigest()
print "BreakALLCTF{%s}" % (sum)
```


# xor

AIS3_Pre_exam_2016-Crypto1

xortool:

[github](https://github.com/hellman/xortool)

安裝:
```
git clone https://github.com/hellman/xortool.git

cd xortool

python setup.py install
```

解題
```
$ xortool -c 20 -m 250 crypto1
```

# 其他學習資源

## 簡報
- [HITCON GIRLS 成大講座 密碼學（阿毛）](https://www.slideshare.net/HITCONGIRLS/hitcon-girls-61507736)
    - 適合對密碼學完全沒概念的人看
- [密碼學漏洞與他們的產地 Crypto fail and where to find them](https://www.slideshare.net/zuan0312/crypto-fail-and-where-to-find-them)
    - 推薦閱讀，講解不少時下常見問題，可以增廣見聞

## 網站
- [CTF wiki](https://ctf-wiki.github.io/ctf-wiki/crypto/introduction/)
    - 資料豐富，打CTF好幫手
    - 我的很多資料也都是參考這裡@@



